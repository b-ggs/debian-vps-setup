#!/usr/bin/env bash

if [[ -z "$USERNAME" ]]; then
  echo "Missing USERNAME!"
  exit 1
fi

if [[ -z "$ENCRYPTED_PASSWORD" ]]; then
  echo "Missing ENCRYPTED_PASSWORD!"
  exit 1
fi

if [[ -z "${HOST_PUBKEY[@]}" ]]; then
  echo "Missing HOST_PUBKEY!"
  exit 1
fi

SSH_PORT="${SSH_PORT:-"22"}"
SSH_CONFIG_PATH="${SSH_CONFIG_PATH:-"/etc/ssh/sshd_config"}"

echo "Creating user "$USERNAME"..."

USER_HOME="/home/$USERNAME"

useradd -g sudo -s "$(which bash)" -m -d $USER_HOME -p "$ENCRYPTED_PASSWORD" "$USERNAME"

echo "Backing up "$SSH_CONFIG_PATH"..."

mv "$SSH_CONFIG_PATH" "$SSH_CONFIG_PATH".bak

echo "Writing config to "$SSH_CONFIG_PATH"..."

echo "Port "$SSH_PORT"
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
PermitRootLogin no
X11Forwarding no
IgnoreRhosts yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
" > "$SSH_CONFIG_PATH"

echo "Writing pubkey to "$USERNAME"'s authorized keys..."

mkdir -p "$USER_HOME/.ssh"
echo "${HOST_PUBKEY[@]}" > "$USER_HOME/.ssh/authorized_keys"

echo "Restarting SSH service..."

service ssh restart
