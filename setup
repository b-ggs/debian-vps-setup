#!/usr/bin/env bash

USERNAME="$1"
PASSWORD="$2"
HOST_PUBKEY="$3"
SSH_PORT="${4:-"22"}"
USER_SHELL="${5:-"$(which bash)"}"
SSH_CONFIG_PATH="${6:-"/etc/ssh/sshd_config"}"

echo "$USERNAME"
echo "$PASSWORD"
echo "$HOST_PUBKEY"
echo "$SSH_PORT"
echo "$USER_SHELL"
echo "$SSH_CONFIG_PATH"

if [[ -z "$USERNAME" ]]; then
  echo "Missing USERNAME!"
  exit 1
fi

if [[ -z "$PASSWORD" ]]; then
  echo "Missing PASSWORD!"
  exit 1
fi

if [[ -z "$HOST_PUBKEY" ]]; then
  echo "Missing HOST_PUBKEY!"
  exit 1
fi

echo "Creating user $USERNAME..."

useradd -g sudo -s "$(which bash)" -m -d "/home/$USERNAME" -p "$PASSWORD" "$USERNAME"

echo "Backing up $SSH_CONFIG_PATH..."

mv $SSH_CONFIG_PATH $SSH_CONFIG_PATH.bak

echo "Writing config to $SSH_CONFIG_PATH..."

echo "Port "$SSH_PORT"
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
PermitRootLogin no
X11Forwarding no
IgnoreRhosts yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
" > $SSH_CONFIG_PATH

echo "Writing pubkey "$HOST_PUBKEY" to "$USERNAME"'s authorized keys..."

su -c "mkdir -p \$HOME/.ssh;
echo "$HOST_PUBKEY" > \$HOME/.ssh/authorized_keys" $USERNAME

echo "Restarting SSH service..."

service ssh restart
